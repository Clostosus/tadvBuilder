<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Choose Your Own Adventure</title>
<style>/* Globals */
:root {
    --color-text: #1e293b;        /* primary textcolor */
    --color-background: #f8fafc;  /* Background */
    --color-highlight-background: #c6d9e8;
    --color-foreground: #3b82f6;  /* accent color (e.g. buttons, links) */
    --color-accent: #0ea5e9;      /* secondary accent color for details */

    --color-success: #166534;
    --color-error: #9b2c2c;
}

:root[data-theme="warm"] {
    --color-text: #3a2f2a;
    --color-background: #faf5f1;
    --color-highlight-background: #eee4dd;
    --color-foreground: #b48a76;
    --color-accent: #d4a98c;

    --color-success: #3c6f57;
    --color-error: #9a4a3f;
}

body {
    font-family: system-ui, sans-serif;
    margin: 2rem;
    line-height: 1.6;

    background-color: var(--color-background);
    color: var(--color-text);
}
h1, h2 {
    color: var(--color-text);
}
textarea, input, select {
    display: block;
    margin-top: 0.5rem;
    margin-bottom: 1rem;
    width: 100%;
    padding: 0.6rem;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid var(--color-foreground);
    box-sizing: border-box;
}
input[type="text"]::before, textarea::before {
    font-family: inherit;
}
label {
    margin-top: 1rem;
    font-weight: bold;
}
button {
    background-color: var(--color-foreground);
    color: var(--color-background);
    border: none;
    padding: 0.6rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-weight: 500;
}
button:hover {
    background-color: var(--color-accent);
}
.section {
    background: var(--color-background);;
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
.sectionHighlighted {
    background-color: var(--color-highlight-background);
    border-left: 5px solid var(--color-accent);
}
.bluesidebarP {
    font-size: 0.875rem;
    background-color: var(--color-foreground);
    padding: 0.5rem 1rem;
    border-left: 4px solid var(--color-foreground);
    border-radius: 4px;
    margin-bottom: 1rem;
}

.feedback-success {
    color: var(--color-success);
}

.feedback-error {
    color: var(--color-error);
}
.choice-inputs {
    margin-bottom: 1rem;
    display: grid;
    gap: 0.5rem;
}
.help {
    font-size: 0.875rem;
    color: var(--color-text);
    margin-top: -0.5rem;
    margin-bottom: 0.5rem;
}

.intro {
    padding: 1rem;
    margin-bottom: 2rem;
    border-radius: 8px;
    font-size: 0.9rem;
}
.intro h1 {
    font-size: 2rem;
    color: var(--color-foreground);
    margin-bottom: 0.25rem;
}
.intro h2 {
    margin-top: -0.5rem;
    color: var(--color-text);
    font-weight: normal;
    font-size: 1.2rem;
}

#output, #preview, #play-area, #tree-output {
    background: var(--color-background);
    border: 1px solid var(--color-foreground);
    padding: 1rem;
    border-radius: 8px;
    white-space: pre-wrap;
    font-family: ui-monospace, SFMono-Regular, monospace;
}

#play-area button {
    margin-top: 0.5rem;
}

/* TreeEditor styles */
.story-tree {
    list-style: none;
    padding-left: 0.75rem;
}
.tree-node-header {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    position: relative;
}
.tree-node {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}
.tree-node-preview {
    opacity: 0.7;
    font-style: italic;
}
.tree-toggle, .tree-delete {
    min-width: 1.5rem;
    height: 1.5rem;
    padding: 0 0.25rem;
    line-height: 1.2rem;
}
.tree-toggle-spacer {
    display: inline-block;
    width: 1.5rem;
    height: 1.5rem;
}
.tree-delete {
    visibility: hidden; /* only show on hover */
    background-color: transparent;
    color: var(--color-text);
    border: 1px solid transparent;
    margin-left: 0.25rem;
}
.tree-node-header:hover .tree-delete {
    visibility: visible;
    border-color: var(--color-foreground);
}
.tree-edge {
    color: var(--color-text);
    opacity: 0.8;
}</style>
</head>
<body>

<div id="intro" class="intro sectionHighlighted">
    <h1>Choose Your Own Adventure</h1>
    <h2>Ein Tool zum Schreiben verzweigter Entscheidungsgeschichten direkt im Browser</h2>
    <p>Dieses Tool hilft dir beim Erstellen von verzweigten Erlebnissen: sogenannte "Entscheidungsgeschichten".
        Leserinnen und Leser k√∂nnen durch ihre Entscheidungen den Verlauf beeinflussen. Jede Szene bekommt einen eindeutigen Schl√ºsselnamen,
        einen Text und eine oder mehrere Auswahlm√∂glichkeiten, die zu anderen Szenen f√ºhren. Du kannst Szenen anlegen, verkn√ºpfen,
        Vorschauen anzeigen lassen und am Ende das komplette Story-Konstrukt als JSON weiterverwenden oder speichern - alles direkt im Browser, komplett offline und lokal.</p>
    <p>Design-Theme:</p>
    <label for="theme-select"></label><select id="theme-select">
        <option value="default">Standard</option>
        <option value="warm">Warm Neutral</option>
    </select>
</div>

<div id="sceneEditor" class="section">
    <label>Schl√ºsselname der Szene:<span class="help">Ein eindeutiger Bezeichner, z.‚ÄØB. <code>start</code> oder <code>kapitel1</code></span></label>
    <label for="scene-key"></label><input type="text" id="scene-key" placeholder="z.‚ÄØB. start">

    <label>Text der Szene:<span class="help">Der eigentliche Erz√§hltext, der dem Leser angezeigt wird</span></label>
    <label for="scene-text"></label><textarea id="scene-text" rows="4" placeholder="Hier deine Szene eingeben..."></textarea>

    <label>Entscheidungen:<span class="help">Welche M√∂glichkeiten der Leser hat und wohin sie f√ºhren</span></label>
    <div id="choices-container">
        <div class="choice-inputs">
            <input type="text" class="choice-text" placeholder="Entscheidungstext">
            <input type="text" class="choice-next" placeholder="N√§chste Szene (Schl√ºssel)">
        </div>
    </div>
    <button id="add-choice-field">Weitere Entscheidung hinzuf√ºgen</button>
    <button id="add-scene">Szene speichern</button>
    <button id="edit-scene">Szeneninhalt √§ndern</button>
    <button id="remove-scene">Szene l√∂schen</button>
    <pre id="scene-status">(noch keine Aktion durchgef√ºhrt)</pre>
</div>

<div id="play-section" class="section">
    <h2>Interaktive Vorschau</h2>
    <p class="help">Die Geschichte wird ab der Szene mit dem Schl√ºssel <code>start</code> gestartet</p>
    <button id="start-story">Geschichte starten</button>
    <div id="play-area"></div>
</div>

<div id="tree-section" class="section">
    <h2>Entscheidungsbaum (ASCII-√úbersicht)</h2>
    <p class="help">Diese einfache Textdarstellung zeigt, welche Szene zu welcher f√ºhrt. Sie wird automatisch aus deinem Story-Aufbau generiert.</p>
    <pre id="tree-output">(noch kein Baum erstellt)</pre>
    <button id="btn-ascii-tree-refresh">Entscheidungsbaum aktualisieren</button>
</div>

<div id="import-export-section" class="section">
    <h2><span class="emoji"></span> Geschichte importieren / exportieren</h2>
    <p class="help">Lade eine bestehende Geschichte (JSON) oder exportiere deine aktuelle Arbeit.</p>

    <label for="json-file">JSON-Datei laden:</label>
    <input type="file" id="json-file" accept=".json" />
    <button id="import-json">Importieren von JSON</button>
    <button id="export-json">Exportieren als JSON</button>
    <button id="export-html">Exportieren als HTML</button>

    <pre id="import-status">(kein Import durchgef√ºhrt)</pre>
</div>

<div id="tree-html-section" class="section">
    <h2>Entscheidungsbaum (HTML-Ansicht)</h2>
    <p class="help">Diese schreibgesch√ºtzte Ansicht rendert den Baum als verschachtelte Liste. √Ñnderungen sind hier nicht m√∂glich.</p>
    <button id="btn-html-tree-refresh">HTML-Baum aktualisieren</button>
    <div id="tree-html-area"></div>
    <!-- Der Inhalt wird bei jedem Rendern vollst√§ndig ersetzt (immutable view). -->
    
</div>

<script>var $=(i,e,t)=>{if(!e.has(i))throw TypeError("Cannot "+t)};var v=(i,e,t)=>($(i,e,"read from private field"),t?t.call(i):e.get(i)),g=(i,e,t)=>{if(e.has(i))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(i):e.set(i,t)};var a=(i,e,t)=>($(i,e,"access private method"),t);var p=class{constructor(e,t="",n=null,o=null){if(this.key=e,this.text=t,this.parent=n,this.choices=new Map,o instanceof Map)for(let[s,c]of o)this.choices.set(s,c);else if(Array.isArray(o))for(let s of o)s.next&&s.text&&this.choices.set(s.next,s.text)}addChoice(e,t){return this.choices.has(t)?!1:(this.choices.set(t,e),!0)}updateChoice(e,t){return this.choices.has(e)?(this.choices.set(e,t),!0):!1}removeChoice(e){return this.choices.delete(e)}getAllChoices(){return Array.from(this.choices,([e,t])=>({text:t,next:e}))}static fromJson(e,t){if(!e||!t)return null;let n=null;if(typeof t=="string")try{n=JSON.parse(t)}catch(s){return console.error(`Failed to parse JSON for scene ${e}: ${s}`),null}else if(typeof t=="object")n=t;else return console.error(`Failed to parse JSON for scene ${e}: Invalid JSON type`),null;if(!n.text||typeof n.text!="string")return console.error(`Scene ${e} missing text property.`),null;let o=new p(e,n.text,null,[]);if(Array.isArray(n.choices))for(let s of n.choices)!s||typeof s.text!="string"||typeof s.next!="string"||o.addChoice(s.text,s.next);return o}toJSON(){let e=[];for(let[t,n]of this.choices.entries())e.push({text:n,next:t});return e.length===0?{text:this.text}:{text:this.text,choices:e}}};var I=class{constructor(e){this.sceneClass=e,this.scenes=new Map,this.root=null}addScene(e){if(!(e instanceof this.sceneClass)||this.scenes.has(e.key))return!1;if(this.scenes.set(e.key,e),!this.root)return this.root=e,!0;if(!e.parent&&this.root&&this.scenes.size>0){let t=this.findParent(e.key);t?(e.parent=t,t.addChoice(e.text||`to ${e.key}`,e.key)):(this.root.addChoice(e.text||`to ${e.key}`,e.key),e.parent=this.root)}return e.parent&&this.scenes.has(e.parent.key)&&this.scenes.get(e.parent.key).addChoice(e.text||`to ${e.key}`,e.key),!0}findParent(e){for(let t of this.scenes.values())if(t.choices instanceof Map&&t.choices.has(e))return t;return null}getScene(e){return this.scenes.get(e)||null}static getSceneDepth(e,t){if(!e.has(t.key))return-1;let n=0,o=t;for(;o&&o.parent;)n++,o=o.parent;return n}static getScenesDFS(e,t=e.root){if(!e||!t)return[];let n=[],o=[],s=new Set,c=0;for(t!==e.root&&(c=I.getSceneDepth(e.scenes,t)),o.push({scene:t,depth:c});o.length>0;){let{scene:r,depth:h}=o.pop();if(s.has(r.key))continue;s.add(r.key),n.push({key:r.key,scene:r,depth:h});let l=Array.from(r.choices.keys()).map(d=>e.getScene(d)).filter(d=>d&&!s.has(d.key));for(let d=l.length-1;d>=0;d--)o.push({scene:l[d],depth:h+1})}return n}static hasCircle(e){let t=new Set,n=I.getScenesDFS(e);for(let{scene:o}of n)if(o){for(let s of o.choices.keys()){let c=e.getScene(s);if(c&&t.has(c.key))return!0}t.add(o.key)}return!1}editSceneContent(e,t,n=null){let o=this.scenes.get(e);if(!o)return console.warn(`Scene ${e} not found`),!1;if(t&&(o.text=t),n)for(let[s,c]of n.entries())o.updateChoice(s,c)||console.warn(`Failed to edit choice ${s} in scene ${e}`);return!0}editSceneChoices(e,t){let n=this.scenes.get(e);return n?(n.choices=new Map(t),!0):(console.warn(`Scene ${e} not found`),!1)}changeSceneParent(e,t){let n=this.scenes.get(e);n||console.warn(`Scene ${e} not found`);let o=n.parent.choices.get(n.key).text;n.parent.removeChoice(n.key);let s=this.scenes.get(t);return s?(n.parent=s,s.addChoice(o||`to ${n.key}`,n.key),!0):(n.parent=null,!1)}removeScene(e){let t=this.scenes.get(e);if(!t)return console.warn(`Scene ${e} not found`),!1;t.parent&&t.parent.removeChoice(t.key);let n=I.getScenesDFS(this,t);for(let o=n.length-1;o>=0;o--){let{key:s}=n[o];this.scenes.delete(s)}return!0}toJSON(){let e={};for(let[t,n]of this.scenes.entries())e[t]=n.toJSON();return e}static fromJson(e,t){if(!e||typeof e!="object")return null;if(typeof t.fromJson!="function")return console.warn("SceneClass has no method called: fromJson"),null;let n=new I(t);for(let[o,s]of Object.entries(e)){let c=t.fromJson(o,s);if(c)n.addScene(c);else return console.warn(`Failed to load scene ${o}`),null}return n.scenes.size===0?(console.warn("No scenes found in JSON"),null):n}};var y=class{constructor(){throw new Error("Static class")}static async loadFromJson(e,t,n){if(!e||typeof e!="string")return null;let o=null;try{let s=await fetch(e);if(!s.ok)return null;o=await s.json()}catch{return null}return typeof n.fromJson!="function"?(console.warn("StoryClass has no method called: fromJson"),null):n.fromJson(o,t)}static async saveToJson(e,t){if(!e||!t||typeof t!="string")return console.error("Ung√ºltige Eingabeparameter in saveToJson: story = ",e,", filename = ",t),!1;let n=e.toJSON();try{let o=JSON.stringify(n),s=new Blob([o],{type:"text/json"}),c=document.createElement("a");c.href=URL.createObjectURL(s),c.download=t,c.click(),URL.revokeObjectURL(c.href),console.log("Story saved to Json")}catch(o){return console.error("Failed to save story to Json:"+o),!1}return!0}static async saveToHtml(e,t){if(!e||!t||typeof t!="string")return console.error("Ung√ºltige Eingabeparameter in saveToHtml: story = ",e,", filename = ",t),!1;let n="PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImRlIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8dGl0bGU+U3RvcnktVmlld2VyPC90aXRsZT4KICAgIDxzdHlsZT4KICAgICAgICBib2R5IHsKICAgICAgICAgICAgZm9udC1mYW1pbHk6IHN5c3RlbS11aSwgc2Fucy1zZXJpZjsKICAgICAgICB9CiAgICAgICAgaDIgewogICAgICAgICAgICBjb2xvcjogIzBmMTcyYTsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMC4yNXJlbTsKICAgICAgICB9CiAgICAgICAgI2dhbWUgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZjFmNWY5OwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjY2JkNWUxOwogICAgICAgICAgICBwYWRkaW5nOiAxcmVtOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgICAgICAgIG1hcmdpbjogMCBhdXRvOwogICAgICAgICAgICBtYXgtd2lkdGg6IDgwMHB4OwogICAgICAgICAgICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgNHB4IDEycHggcmdiYSgwLDAsMCwwLjA2KTsKICAgICAgICB9CiAgICAgICAgI2dhbWUgYnV0dG9uIHsKICAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogIzNiODJmNjsKICAgICAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICAgICAgYm9yZGVyOiBub25lOwogICAgICAgICAgICBwYWRkaW5nOiAwLjZyZW0gMXJlbTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIG1hcmdpbi10b3A6IDAuNXJlbTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDUwMDsKICAgICAgICB9CiAgICA8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5Pgo8ZGl2IGlkPSJnYW1lIj48L2Rpdj4KCjxzY3JpcHQ+CiAgICBjb25zdCBzdG9yeSA9IHsKICAgICAgICAvLyBJTlNFUlQgSlNPTiBTVE9SWSBIRVJFCg==",o="ICAgIH07CgogICAgZnVuY3Rpb24gc2hvd1NjZW5lKGtleSkKICAgIHsKICAgICAgICBjb25zdCBzY2VuZSA9IHN0b3J5W2tleV07CiAgICAgICAgaWYgKCFzY2VuZSkgcmV0dXJuOwoKICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZ2FtZSIpOwogICAgICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAiIjsgLy8gZGVsZXRlIHByZXZpb3VzIGNvbnRlbnQvc2NlbmUKCiAgICAgICAgY29uc3QgdGl0bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJoMiIpOwogICAgICAgIHRpdGxlLnRleHRDb250ZW50ID0ga2V5OyBjb250YWluZXIuYXBwZW5kQ2hpbGQodGl0bGUpOwoKICAgICAgICBjb25zdCB0ZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicCIpOwogICAgICAgIHRleHQudGV4dENvbnRlbnQgPSBzY2VuZS50ZXh0OyBjb250YWluZXIuYXBwZW5kQ2hpbGQodGV4dCk7CgogICAgICAgIGlmICghc2NlbmUuY2hvaWNlcyB8fCBzY2VuZS5jaG9pY2VzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoKICAgICAgICBmb3IgKGNvbnN0IGMgb2Ygc2NlbmUuY2hvaWNlcykgewogICAgICAgICAgICBjb25zdCBidXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJidXR0b24iKTsKICAgICAgICAgICAgYnV0dG9uLnRleHRDb250ZW50ID0gYy50ZXh0OwogICAgICAgICAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKSA9PiBzaG93U2NlbmUoYy5uZXh0KSk7CiAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChidXR0b24pOwogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnIiKSk7CiAgICAgICAgfQogICAgfQoKICAgIHNob3dTY2VuZSgic3RhcnQiKTsKPC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPg==",s=e.toJSON(),c=JSON.stringify(s);c=c.slice(1,-1);try{let r=window.atob(n)+c+window.atob(o),h=new Blob([r],{type:"text/html"}),l=document.createElement("a");l.href=URL.createObjectURL(h),l.download=t,l.click(),URL.revokeObjectURL(l.href),console.log("Story saved to Html")}catch(r){return console.error("Failed to save story to Json:"+r),!1}return!0}};var A=class{static generateTreeAscii(e,t=document.getElementById("tree-output")){if(console.log("StoryTreeRenderer.generateTreeAscii. Parent: "+t.id+" Story: "+e.root.key),!t)return;if(!e||!e.root){t.textContent="(noch kein Baum erstellt)";return}let n=I.getScenesDFS(e,e.root),o=[];for(let c=0;c<n.length;c++){let{key:r,scene:h,depth:l}=n[c],d="";for(let m=0;m<l;m++)d+=m===l-1?"|_ ":"   ";r=String(r),h===null?o.push(d+"["+r+"](MISSING)"):o.push(d+r)}let s=o.join(`
`);t.textContent=s}};var u=class{static show(e,t,n,o="create"){if(!t)return;let s=n?"feedback-success":"feedback-error";if(o==="create"){let c=document.createElement("div");c.textContent=e,c.classList.add("feedback",s),t.appendChild(c),setTimeout(()=>c.remove(),3e3)}else o==="set"&&(t.textContent=e,t.classList.add("feedback",s))}};var f=class{static render(e,t,n="play-area"){let o=document.getElementById(n);if(!o)return;let s=e.getScene(t);if(o.innerHTML="",!s){let h=document.createElement("p"),l=document.createElement("em");l.textContent="Szene '"+t+"' nicht gefunden.",h.appendChild(l),o.textContent="",o.appendChild(h);return}let c=document.createElement("p"),r=document.createElement("strong");r.textContent=t,c.append(r,": "+s.text),o.appendChild(c);for(let[h,l]of s.choices.entries()){let d=document.createElement("button");d.textContent=l,d.onclick=()=>f.render(e,h,n),o.appendChild(d),o.appendChild(document.createElement("br"))}}};var S=class{constructor(e){this.story=e}static addChoiceField(){let e=document.getElementById("choices-container");if(!e){console.error("parentElement is not found.");return}let t=document.createElement("div");t.className="choice-inputs",t.innerHTML=`
        <input type="text" class="choice-text" placeholder="Entscheidungstext">
        <input type="text" class="choice-next" placeholder="N√§chste Szene (Schl√ºssel)">
      `,e.appendChild(t)}addScene(){let e=document.getElementById("scene-key").value.trim(),t=document.getElementById("scene-text").value.trim(),n=document.getElementById("sceneEditor");if(!e||!t){u.show("Bitte Schl√ºssel und Text ausf√ºllen.",n,!1);return}let o=document.querySelectorAll(".choice-inputs"),s=new Map;if(o.forEach(r=>{let h=r.querySelector(".choice-text").value.trim(),l=r.querySelector(".choice-next").value.trim();h&&l&&s.set(l,h)}),!this.story.addScene(new p(e,t,null,s))){u.show("Scene could not be added to story, key already exists.",n,!1);return}f.render(this.story,e),A.generateTreeAscii(this.story),document.getElementById("scene-key").value="",document.getElementById("scene-text").value="";let c=document.getElementById("choices-container");c.innerHTML=`<div class="choice-inputs">
    <input type="text" class="choice-text" placeholder="Entscheidungstext">
    <input type="text" class="choice-next" placeholder="N√§chste Szene (Schl√ºssel)">
    </div>`,u.show("Szene wurde gespeichert.",n,!0)}editScene(){let e=document.getElementById("scene-key"),t=document.getElementById("scene-status"),n=document.getElementById("scene-text"),o=document.getElementById("choices-container"),s=e.value.trim(),c=n.value.trim();if(!s){u.show("Bitte gib den Schl√ºssel der zu bearbeitenden Szene ein.",t,!1);return}let r=new Map;for(let l of o.children){if(!l.classList.contains("choice-inputs"))continue;let d=l.querySelector(".choice-text"),m=l.querySelector(".choice-next");(!d||!m||!(d instanceof HTMLInputElement)||!(m instanceof HTMLInputElement))&&console.log("Error in editScene: Invalid choice input elements. Skipping choice."),r.set(m.value.trim(),d.value.trim())}this.story.editSceneContent(s,c,r)&&(f.render(this.story,s),u.show("Szene wurde erfolgreich bearbeitet.",t,!0))}removeScene(){let e=document.getElementById("scene-key"),t=e.value.trim(),n=document.getElementById("scene-status");if(!t){u.show("Bitte gib den Schl√ºssel der zu l√∂schenden Szene ein.",n,!1);return}if(!confirm(`Soll die Szene "${t}" wirklich gel√∂scht werden?`))return;if(!this.story.removeScene(t)){u.show(`Keine Szene mit dem Schl√ºssel "${t}" gefunden.`,n,!1);return}f.render(this.story,this.story.root.key),u.show(`Szene "${t}" wurde erfolgreich gel√∂scht.`,n,!0),e.value="",document.getElementById("scene-text").value="",A.generateTreeAscii(this.story)}};var x,L,Q,Z,q,N,_,J,ee,R,te,j,ne,G,oe,w,D,T,se,W,ce,Y,re,z,ie,O,le,V,de,k,M,B,K,H,ae,X=class{constructor(e){g(this,Z);g(this,N);g(this,J);g(this,R);g(this,j);g(this,G);g(this,w);g(this,T);g(this,W);g(this,Y);g(this,z);g(this,O);g(this,V);g(this,k);g(this,B);g(this,H);this.targetElementId=e,this.expanded=new Set}static render(e,t="tree-html-area"){var o;a(o=X,L,Q).call(o,t).render(e)}render(e){let t=a(this,Z,q).call(this);if(!t)return;if(a(this,N,_).call(this,t),!a(this,J,ee).call(this,e)){a(this,R,te).call(this,t);return}a(this,j,ne).call(this,e);let n=a(this,G,oe).call(this);a(this,w,D).call(this,e.root.key,n,e,new Set),t.appendChild(n)}},b=X;x=new WeakMap,L=new WeakSet,Q=function(e){return v(this,x).has(e)||v(this,x).set(e,new X(e)),v(this,x).get(e)},Z=new WeakSet,q=function(){let e=document.getElementById(this.targetElementId);return e||console.warn(`TreeEditor: container with id "${this.targetElementId}" not found.`),e},N=new WeakSet,_=function(e){e.innerHTML=""},J=new WeakSet,ee=function(e){return!!(e&&e.root)},R=new WeakSet,te=function(e){let t=document.createElement("p");t.textContent='Keine Startszene gefunden. Lege zuerst eine Szene mit dem Schl√ºssel "start" an.',e.appendChild(t)},j=new WeakSet,ne=function(e){this.expanded.has(e.root.key)||this.expanded.add(e.root.key)},G=new WeakSet,oe=function(){let e=document.createElement("ul");return e.classList.add("story-tree"),e},w=new WeakSet,D=function(e,t,n,o){let s=document.createElement("li"),c=n.getScene(e);if(!c){s.textContent=`${e} (Szene nicht gefunden)`,t.appendChild(s);return}let r=a(this,T,se).call(this,e,c,n);if(s.appendChild(r),t.appendChild(s),o.has(e)){let m=document.createElement("em");m.textContent=" (Zyklus)",s.appendChild(m);return}if(!a(this,k,M).call(this,c)||!a(this,B,K).call(this,e))return;let l=document.createElement("ul");s.appendChild(l);let d=new Set(o);d.add(e);for(let[m,ge]of c.choices.entries()){let F=document.createElement("li"),U=document.createElement("span");U.classList.add("tree-edge"),U.textContent=`‚Üí ${ge}`,F.appendChild(U);let P=document.createElement("ul");F.appendChild(P),l.appendChild(F),a(this,w,D).call(this,m,P,n,d)}},T=new WeakSet,se=function(e,t,n){let o=document.createElement("div");o.classList.add("tree-node-header");let s=n&&n.root&&n.root.key===e;if(!s&&a(this,k,M).call(this,t)){let r=a(this,W,ce).call(this,e,n);o.appendChild(r)}else o.appendChild(a(this,Y,re).call(this));let c=a(this,z,ie).call(this,e,t);if(o.appendChild(c),!s){let r=a(this,O,le).call(this,e,n);c.appendChild(r)}return o},W=new WeakSet,ce=function(e,t){let n=a(this,B,K).call(this,e),o=document.createElement("button");return o.classList.add("tree-toggle"),o.setAttribute("aria-label",n?"Einklappen":"Ausklappen"),o.setAttribute("aria-expanded",String(n)),o.textContent=n?"‚àí":"+",o.addEventListener("click",s=>a(this,V,de).call(this,s,e,t)),o},Y=new WeakSet,re=function(){let e=document.createElement("span");return e.classList.add("tree-toggle-spacer"),e},z=new WeakSet,ie=function(e,t){let n=document.createElement("span");n.classList.add("tree-node");let o=document.createElement("strong");return o.textContent=e,n.appendChild(o),n},O=new WeakSet,le=function(e,t){let n=document.createElement("button");return n.classList.add("tree-delete"),n.setAttribute("aria-label",`Szene "${e}" l√∂schen`),n.textContent="üóë",n.addEventListener("click",o=>{if(o.preventDefault(),o.stopPropagation(),!confirm(`Soll die Szene "${e}" wirklich gel√∂scht werden?`))return;if(!t.removeScene(e)){console.warn(`TreeEditor: Szene "${e}" konnte nicht gel√∂scht werden.`);return}this.expanded.delete(e),this.render(t)}),n},V=new WeakSet,de=function(e,t,n){e.preventDefault(),e.stopPropagation(),a(this,H,ae).call(this,t),this.render(n)},k=new WeakSet,M=function(e){return!!(e.choices&&e.choices.size)},B=new WeakSet,K=function(e){return this.expanded.has(e)},H=new WeakSet,ae=function(e){this.expanded.has(e)?this.expanded.delete(e):this.expanded.add(e)},g(b,L),g(b,x,new Map);var C=new I(p),E=new S(C,p);function ue(){if(!C.root){alert("Keine 'start'-Szene gefunden.");return}f.render(C,"start")}async function he(){let i=document.getElementById("json-file"),e=document.getElementById("import-status");if(!i.files.length){u.show("Bitte zuerst eine JSON-Datei ausw√§hlen.",e,!1);return}let t=i.files[0],n=URL.createObjectURL(t);try{if(C=await y.loadFromJson(n,p,I),!C){e.textContent="Fehler beim Laden: Story konnte nicht geladen werden.";return}E.story=C,u.show(`"${t.name}" erfolgreich geladen (${C.scenes.size} Szenen).`,e,!0),A.generateTreeAscii(C),b.render(C),ue()}catch(o){u.show("Fehler beim Laden: "+o.message,e,!1)}finally{URL.revokeObjectURL(n)}}function Ce(){if(!C){u.show("No story available to export.",document.getElementById("import-status"),!1);return}y.saveToJson(C,"story.json")&&u.show("Story successfully exported to JSON.",document.getElementById("import-status"),!0)}function Ie(){if(!C){u.show("No story available to export.",document.getElementById("import-status"),!1);return}y.saveToHtml(C,"story.html")&&u.show("Story successfully exported to HTML.",document.getElementById("import-status"),!0)}function me(i){i==="default"?document.documentElement.removeAttribute("data-theme"):document.documentElement.setAttribute("data-theme",i)}window.renderScene=i=>f.render(C,i);window.removeScene=()=>E.removeScene();window.addEventListener("DOMContentLoaded",()=>{console.log("page is fully loaded"),document.getElementById("add-choice-field").addEventListener("click",S.addChoiceField),document.getElementById("add-scene").addEventListener("click",()=>E.addScene()),document.getElementById("remove-scene").addEventListener("click",()=>E.removeScene()),document.getElementById("edit-scene").addEventListener("click",()=>E.editScene()),document.getElementById("start-story").addEventListener("click",ue),document.getElementById("btn-ascii-tree-refresh").addEventListener("click",()=>{A.generateTreeAscii(C)});let i=document.getElementById("btn-html-tree-refresh");i&&i.addEventListener("click",()=>b.render(C)),document.getElementById("import-json").addEventListener("click",he),document.getElementById("export-json").addEventListener("click",Ce),document.getElementById("export-html").addEventListener("click",Ie),document.getElementById("theme-select").addEventListener("change",function(){me(this.value)})});
//# sourceMappingURL=bundle.js.map</script>
</body>
